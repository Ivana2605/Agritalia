<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Izve≈°taj tro≈°kova</title>

<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    font-family: 'Rubik', sans-serif;
    max-width: 480px;
    margin: 0 auto;
    padding: 10px;
    background-color: #f7f7f7;
    color: #2e7d32;
    text-align: center;
    overflow-x: hidden;
}
h2 { margin: 20px 0; }
form {
    margin-top: 20px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    text-align: left;
    box-sizing: border-box;
}
label { display: block; margin: 10px 0 5px; font-weight: 500; }
input {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    font-size: 15px;
    margin-bottom: 10px;
}
button {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    color: white;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
}
button:hover { opacity: 0.9; }
.pdfBtn { background: #1565c0; margin-top: 15px; }
.backBtn { background: #d32f2f; margin-top: 20px; }
.results {
    background: white;
    border-radius: 10px;
    padding: 15px;
    text-align: left;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin-top: 20px;
}
canvas { margin-top: 20px; }
</style>
</head>
<body>

<h2>Izve≈°taj tro≈°kova</h2>

<form id="filterForm">
    <label for="datumOd">Datum od:</label>
    <input type="date" id="datumOd" required>

    <label for="datumDo">Datum do:</label>
    <input type="date" id="datumDo" required>

    <button type="submit" style="background-color:#2e7d32;">Prika≈æi izve≈°taj</button>
</form>

<div id="izvestajSadrzaj" style="display:none;">
    <canvas id="troskoviChart" height="200"></canvas>
    <div id="rezultati" class="results"></div>
    <button id="pdfBtn" class="pdfBtn">üìÑ Preuzmi izve≈°taj (PDF)</button>
</div>

<!-- Dugme Nazad -->
<button class="backBtn" type="button" onclick="window.location.href='troskovi.html'">‚¨Ö Nazad</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase konfiguracija
const firebaseConfig = {
    apiKey: "AIzaSyBGeFazvjgtDUbB-VSJlEcXDe4bW-r0sJs",
    authDomain: "agritalia-app.firebaseapp.com",
    projectId: "agritalia-app",
    storageBucket: "agritalia-app.appspot.com",
    messagingSenderId: "935329247921",
    appId: "1:935329247921:web:d9de1aa832e2432170a890"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

function formatDatum(d) {
    const date = new Date(d);
    const dan = String(date.getDate()).padStart(2,'0');
    const mesec = String(date.getMonth()+1).padStart(2,'0');
    const godina = date.getFullYear();
    return `${dan}.${mesec}.${godina}.`;
}

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        alert("Morate biti prijavljeni!");
        window.location.href = "index.html";
        return;
    }

    document.getElementById("filterForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const datumOd = document.getElementById("datumOd").value;
        const datumDo = document.getElementById("datumDo").value;

        if (!datumOd || !datumDo) {
            alert("Molimo izaberite oba datuma!");
            return;
        }

        const q = query(collection(db, "troskovi"), where("userId", "==", user.uid));
        const snapshot = await getDocs(q);

        let filtered = [];
        snapshot.forEach(docSnap => {
            const t = docSnap.data();
            if (!t.datum) return;
            if (t.datum >= datumOd && t.datum <= datumDo) filtered.push(t);
        });

        if (filtered.length === 0) {
            document.getElementById('rezultati').innerHTML = "<p>Nema tro≈°kova za izabrani period.</p>";
            document.getElementById('izvestajSadrzaj').style.display = "block";
            if (window.chartInstance) window.chartInstance.destroy();
            return;
        }

        const poTipu = {};
        let detaljiHTML = "";
        let total = 0;

        filtered.forEach(t => {
            let ukupno = t.trosak || 0;
            if (t.tip === "Sezonci") {
                ukupno = (t.trosakPoRadniku || 0) * (t.brojRadnika || 0) + (t.trosakPrevoza || 0);
            } else if (t.tip === "ƒêubriva" || t.tip === "Pesticidi") {
                ukupno = (t.trosak || 0) * (t.kolicina || 1);
            }
            poTipu[t.tip] = (poTipu[t.tip] || 0) + ukupno;
            total += ukupno;

            detaljiHTML += `
                <div>
                    <strong>${formatDatum(t.datum)} - ${t.tip}</strong><br/>
                    ${t.kolicina ? `Koliƒçina: ${t.kolicina}<br/>` : ''}
                    ${t.brojRadnika ? `Broj radnika: ${t.brojRadnika}<br/>` : ''}
                    ${t.trosakPoRadniku ? `Cena po radniku: ${t.trosakPoRadniku} RSD<br/>` : ''}
                    ${t.trosakPrevoza ? `Prevoz: ${t.trosakPrevoza} RSD<br/>` : ''}
                    ${t.trosak ? `Cena: ${t.trosak} RSD<br/>` : ''}
                    Napomena: ${t.napomena || ''}<br/>
                    <strong>Ukupno: ${ukupno.toFixed(2)} RSD</strong>
                </div>
                <hr>
            `;
        });

        const prosek = (total / filtered.length).toFixed(2);

        document.getElementById('rezultati').innerHTML = `
            <h3>Detalji tro≈°kova</h3>
            ${detaljiHTML}
            <h3>Analiza tro≈°kova</h3>
            <p><strong>Ukupan broj unosa:</strong> ${filtered.length}</p>
            <p><strong>Ukupan tro≈°ak:</strong> ${total.toFixed(2)} RSD</p>
            <p><strong>Proseƒçan tro≈°ak po unosu:</strong> ${prosek} RSD</p>
            <ul>
                ${Object.entries(poTipu).map(([tip,vrednost])=>`<li>${tip}: <strong>${vrednost.toFixed(2)} RSD</strong></li>`).join('')}
            </ul>
        `;

        const labels = Object.keys(poTipu);
        const values = Object.values(poTipu);
        const ctx = document.getElementById('troskoviChart');
        if (window.chartInstance) window.chartInstance.destroy();
        window.chartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{ data: values, backgroundColor: ["#2e7d32","#66bb6a","#81c784","#a5d6a7"] }]
            },
            options: { plugins: { legend: { position: "bottom" }, title: { display: true, text: "Udeo tro≈°kova po tipu" } } }
        });

        document.getElementById('izvestajSadrzaj').style.display = "block";
    });
});

document.getElementById('pdfBtn').addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    const sadrzaj = document.getElementById("izvestajSadrzaj");
    const canvasImg = await html2canvas(sadrzaj, { scale: 2 });
    const imgData = canvasImg.toDataURL("image/png");
    const pdfWidth = 190;
    const pdfHeight = (canvasImg.height * pdfWidth) / canvasImg.width;
    pdf.text("Izve≈°taj tro≈°kova", 15, 15);
    pdf.addImage(imgData, "PNG", 10, 25, pdfWidth, pdfHeight);
    const datumOd = document.getElementById('datumOd').value;
    const datumDo = document.getElementById('datumDo').value;
    pdf.save(`Izvestaj_troskova_${datumOd}_do_${datumDo}.pdf`);
});
</script>

</body>
</html>













