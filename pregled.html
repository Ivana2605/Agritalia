<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pregled</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
<style>
body {
    font-family: 'Rubik', sans-serif;
    max-width: 600px;
    margin: 0 auto;
    padding: 10px;
    background-color: #f7f7f7;
    color: #2e7d32;
}
h2 { text-align: center; margin: 20px 0; }
.date-list, .details {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin: 10px 0;
    padding: 15px;
}
.date-item {
    padding: 10px;
    margin: 5px 0;
    background: #e8f5e9;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.date-item:hover { background: #c8e6c9; }
.trash {
    background: none;
    border: none;
    color: #d32f2f;
    font-size: 20px;
    cursor: pointer;
}
.trash:hover { color: #9a0007; }
.detail {
    margin: 10px 0;
    padding: 10px;
    background: #f1f8e9;
    border-radius: 8px;
    border-left: 4px solid #2e7d32;
}
.detail-inline {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-items: center;
}
.detail-inline input {
    flex: 1;
    padding: 6px 8px;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
.editBtn, .saveBtn {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 5px;
    font-weight: 600;
}
.editBtn { background: #0288d1; color: white; font-size: 14px; }
.editBtn:hover { background: #0277bd; }
.saveBtn { background: #2e7d32; color: white; }
.saveBtn:hover { background-color: #27682c; }
button.backBtn {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    background-color: #d32f2f;
    color: white;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
}
.ukupno-datum {
    font-weight: bold;
    margin-top: 10px;
    text-align: right;
    color: #1b5e20;
}
.prihod { border-left-color: #0288d1; background: #e3f2fd; }
</style>
</head>
<body>

<h2>Pregled</h2>
<div id="pregled"></div>
<button class="backBtn" type="button" onclick="window.location.href='dashboard.html'">‚¨Ö Nazad</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBGeFazvjgtDUbB-VSJlEcXDe4bW-r0sJs",
    authDomain: "agritalia-app.firebaseapp.com",
    projectId: "agritalia-app",
    storageBucket: "agritalia-app.appspot.com",
    messagingSenderId: "935329247921",
    appId: "1:935329247921:web:d9de1aa832e2432170a890"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const pregledDiv = document.getElementById("pregled");

function formatDatum(d) {
    const date = new Date(d);
    if (isNaN(date)) return d;
    return `${date.getDate()}.${date.getMonth()+1}.${date.getFullYear()}.`;
}
function formatBroj(n) {
    return new Intl.NumberFormat('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
}

let trenutniPodaci = [];
let ukupnoTroskovi = 0;
let ukupnoPrihodi = 0;

// Funkcija koja prikazuje listu datuma
async function prikaziListuDatuma(user) {
    const troskoviSnap = await getDocs(query(collection(db,"troskovi"), where("userId","==",user.uid)));
    const prihodiSnap = await getDocs(query(collection(db,"prihodi"), where("userId","==",user.uid)));

    if(troskoviSnap.empty && prihodiSnap.empty) {
        pregledDiv.innerHTML="<p style='text-align:center;'>Nema unetih podataka.</p>"; 
        return;
    }

    const poDatumu = {};
    troskoviSnap.forEach(docSnap=>{
        const t = docSnap.data();
        t.id = docSnap.id;
        if(!t.datum) return;
        if(!poDatumu[t.datum]) poDatumu[t.datum]=[];
        t.vrsta = "trosak";
        poDatumu[t.datum].push(t);
    });
    prihodiSnap.forEach(docSnap=>{
        const p = docSnap.data();
        p.id = docSnap.id;
        if(!p.datum) return;
        if(!poDatumu[p.datum]) poDatumu[p.datum]=[];
        p.vrsta = "prihod";
        poDatumu[p.datum].push(p);
    });

    const datumi = Object.keys(poDatumu).sort((a,b)=>b.localeCompare(a));
    pregledDiv.innerHTML="<div class='date-list'><h3>Izaberite datum:</h3></div>";
    const listDiv = pregledDiv.querySelector(".date-list");

    datumi.forEach(datum=>{
        const item = document.createElement("div");
        item.className="date-item";

        const span = document.createElement("span");
        span.textContent=formatDatum(datum);
        span.onclick=()=>prikaziDetalje(datum, poDatumu[datum], user);

        const trashBtn = document.createElement("button");
        trashBtn.className="trash";
        trashBtn.innerHTML="üóëÔ∏è";
        trashBtn.onclick=async (e)=>{
            e.stopPropagation();
            if (confirm(`Obrisati sve unose za datum ${formatDatum(datum)}?`)) {
                for (const p of poDatumu[datum]) {
                    await deleteDoc(doc(db, p.vrsta === "trosak" ? "troskovi" : "prihodi", p.id));
                }
                alert("Podaci obrisani!");
                prikaziListuDatuma(user);
            }
        };

        item.appendChild(span);
        item.appendChild(trashBtn);
        listDiv.appendChild(item);
    });
}

// Funkcija koja prikazuje detalje za datum
function prikaziDetalje(datum, podaci, user){
    trenutniPodaci = podaci;
    ukupnoTroskovi = 0;
    ukupnoPrihodi = 0;
    const detailsDiv = document.createElement("div");
    detailsDiv.className="details";
    let html=`<h3>${formatDatum(datum)}</h3>`;

    podaci.forEach((p, idx)=>{
        let ukupno = 0;
        if(p.vrsta==="trosak"){
            if(p.tip==="Sezonci") ukupno = (p.brojRadnika*p.trosak)+(p.trosakPrevoza||0);
            else if(p.tip==="Pesticidi"||p.tip==="ƒêubriva") ukupno = (p.kolicina*p.trosak);
            else ukupno = p.trosak;
            ukupnoTroskovi+=ukupno;

            html+=`
            <div class="detail" id="detail-${idx}">
                <strong>${p.tip}</strong><br/>
                Broj parcele: ${p.brojParcele||""}<br/>
                Iznos: <span id="iznosPrikaz-${idx}">${formatBroj(ukupno)}</span> RSD<br/>
                Napomena: ${p.napomena||p.opis||""}
            </div>`;
        } else if(p.vrsta==="prihod"){
            const ukupno = p.ukupanPrihod || (p.kolicina*p.prodajnaCena) + (p.ostalo?.iznos||0);
            ukupnoPrihodi+=ukupno;
            html+=`
            <div class="detail prihod" id="detail-${idx}">
                <strong>Prihod (${p.kultura||p.tip||"Prihod"})</strong><br/>
                Broj parcele: ${p.brojParcele||""}<br/>
                Iznos: <span id="iznosPrikaz-${idx}">${formatBroj(ukupno)}</span> RSD
            </div>`;
        }
    });

    html+=`
    <div class="ukupno-datum" id="ukupnoDatum">
        Ukupno tro≈°kovi: <span id="ukTroskovi">${formatBroj(ukupnoTroskovi)}</span> RSD<br/>
        Ukupno prihodi: <span id="ukPrihodi">${formatBroj(ukupnoPrihodi)}</span> RSD<br/>
        <hr/>
        <strong id="rezultat">${ukupnoPrihodi>=ukupnoTroskovi ? "Dobitak" : "Gubitak"}: ${formatBroj(ukupnoPrihodi - ukupnoTroskovi)} RSD</strong>
    </div>`;

    detailsDiv.innerHTML=html;
    pregledDiv.innerHTML="";
    pregledDiv.appendChild(detailsDiv);

    // Dugme izmeni
    const izmeniBtn=document.createElement("button");
    izmeniBtn.textContent="Izmeni";
    izmeniBtn.className="editBtn";
    izmeniBtn.style.display = "block";
    izmeniBtn.style.margin = "10px auto";
    izmeniBtn.onclick=()=>omoguciIzmenu();
    pregledDiv.appendChild(izmeniBtn);

    // Dugme nazad
    const nazadBtn=document.createElement("button");
    nazadBtn.textContent="‚¨Ö Nazad na listu datuma";
    nazadBtn.className="backBtn";
    nazadBtn.onclick = () => prikaziListuDatuma(user); // ovo sada radi
    pregledDiv.appendChild(nazadBtn);
}

// Omoguƒáavanje izmene sa inline inputima
function omoguciIzmenu() {
    trenutniPodaci.forEach((p, idx)=>{
        const div = document.getElementById(`detail-${idx}`);
        if(!div) return;
        div.innerHTML = `
            <div class="detail-inline">
                <input type="text" id="brojParcele-${idx}" value="${p.brojParcele||''}" placeholder="Broj parcele"/>
                <input type="number" id="iznos-${idx}" value="${p.trosak||p.ukupanPrihod||0}" placeholder="Iznos"/>
                <input type="text" id="napomena-${idx}" value="${p.napomena||p.opis||''}" placeholder="Napomena"/>
                <button class="saveBtn" onclick="sacuvajIzmenu('${p.id}', '${p.vrsta==="trosak"?"troskovi":"prihodi"}', ${idx})">Saƒçuvaj</button>
            </div>
        `;
        document.getElementById(`iznos-${idx}`).addEventListener('input', updateUkupno);
    });
}

function updateUkupno() {
    let noviTroskovi = 0, noviPrihodi = 0;
    trenutniPodaci.forEach((p, idx)=>{
        const iznos = parseFloat(document.getElementById(`iznos-${idx}`).value) || 0;
        if(p.vrsta==="trosak") noviTroskovi += iznos;
        else noviPrihodi += iznos;
    });
    document.getElementById("ukTroskovi").textContent = formatBroj(noviTroskovi);
    document.getElementById("ukPrihodi").textContent = formatBroj(noviPrihodi);
    const rezultat = document.getElementById("rezultat");
    const razlika = noviPrihodi - noviTroskovi;
    rezultat.textContent = razlika >=0 ? `Dobitak: ${formatBroj(razlika)} RSD` : `Gubitak: ${formatBroj(-razlika)} RSD`;
    rezultat.style.color = razlika>=0 ? '#1b5e20' : '#d32f2f';
}

window.sacuvajIzmenu = async (id, kolekcija, idx) => {
    const brojParcele = document.getElementById(`brojParcele-${idx}`).value.trim();
    const iznos = parseFloat(document.getElementById(`iznos-${idx}`).value) || 0;
    const napomena = document.getElementById(`napomena-${idx}`).value || "";

    try {
        const updateData = { brojParcele };
        if(kolekcija==="troskovi") updateData.trosak = iznos;
        if(kolekcija==="prihodi") updateData.ukupanPrihod = iznos;
        if(napomena) updateData.napomena = napomena;

        await updateDoc(doc(db, kolekcija, id), updateData);
        alert("Izmena saƒçuvana!");
        prikaziListuDatuma(auth.currentUser); // odmah osve≈æi listu
    } catch(err){
        console.error(err);
        alert("Gre≈°ka pri ƒçuvanju izmene: "+err.message);
    }
}

// Provera prijave i prikaz liste datuma
onAuthStateChanged(auth, user => {
    if (!user) { alert("Morate biti prijavljeni!"); window.location.href="index.html"; return; }
    prikaziListuDatuma(user);
});
</script>

</body>
</html>






