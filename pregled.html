<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pregled</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
<style>
    body {
        font-family: 'Rubik', sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 10px;
        background-color: #f7f7f7;
        color: #2e7d32;
    }
    h2 {
        text-align: center;
        margin: 20px 0;
    }
    .date-list, .details {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        margin: 10px 0;
        padding: 15px;
    }
    .date-item {
        padding: 10px;
        margin: 5px 0;
        background: #e8f5e9;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .date-item:hover {
        background: #c8e6c9;
    }
    .trash {
        background: none;
        border: none;
        color: #d32f2f;
        font-size: 18px;
        cursor: pointer;
    }
    .trash:hover { color: #9a0007; }
    .detail {
        margin: 10px 0;
        padding: 10px;
        background: #f1f8e9;
        border-radius: 8px;
        border-left: 4px solid #2e7d32;
    }
    .detail input {
        width: 80%;
        padding: 5px;
        margin: 3px 0;
    }

    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    input[type=number] { appearance: textfield; }

    .editBtn, .saveBtn {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 5px;
        font-weight: 600;
    }
    .editBtn { background: #0288d1; color: white; }
    .editBtn:hover { background: #0277bd; }
    .saveBtn { background: #2e7d32; color: white; }
    .saveBtn:hover { background-color: #27682c; }

    button.backBtn {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border-radius: 10px;
        border: none;
        background-color: #d32f2f;
        color: white;
        cursor: pointer;
        font-weight: 600;
        margin-top: 20px;
    }
    .ukupno-datum {
        font-weight: bold;
        margin-top: 10px;
        text-align: right;
        color: #1b5e20;
    }
</style>
</head>
<body>

<h2>Pregled</h2>

<div id="pregled"></div>

<button class="backBtn" type="button" onclick="window.location.href='dashboard.html'">‚¨Ö Nazad</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase konfiguracija
const firebaseConfig = {
    apiKey: "AIzaSyBGeFazvjgtDUbB-VSJlEcXDe4bW-r0sJs",
    authDomain: "agritalia-app.firebaseapp.com",
    projectId: "agritalia-app",
    storageBucket: "agritalia-app.appspot.com",
    messagingSenderId: "935329247921",
    appId: "1:935329247921:web:d9de1aa832e2432170a890"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const pregledDiv = document.getElementById("pregled");

// Format datuma
function formatDatum(d) {
    const date = new Date(d);
    const dan = date.getDate();
    const mesec = date.getMonth() + 1;
    const godina = date.getFullYear();
    return `${dan}.${mesec}.${godina}.`;
}

// Format broja (65.000,00)
function formatBroj(n) {
    return new Intl.NumberFormat('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
}

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        alert("Morate biti prijavljeni!");
        window.location.href = "index.html";
        return;
    }

    const troskoviSnap = await getDocs(query(collection(db, "troskovi"), where("userId", "==", user.uid)));
    const prihodiSnap = await getDocs(query(collection(db, "prihodi"), where("userId", "==", user.uid)));

    const poDatumu = {};

    // Grupisanje tro≈°kova
    troskoviSnap.forEach(docSnap => {
        const t = docSnap.data();
        t.id = docSnap.id;
        if (!t.datum) return;
        if (!poDatumu[t.datum]) poDatumu[t.datum] = [];

        let kolicina = 0;
        let cena = 0;
        let prevoz = 0;

        switch (t.tip) {
            case "Gorivo":
                kolicina = t.kolicinaLitara || 0;
                cena = t.cenaPoLitru || 0;
                break;
            case "Sezonci":
                kolicina = t.brojRadnika || 0;
                cena = t.trosakPoRadniku || 0;
                prevoz = t.trosakPrevoza || 0;
                break;
            case "ƒêubriva":
            case "Pesticidi":
                kolicina = t.kolicina || 0;
                cena = t.trosak || t.trosakPoJedinici || 0;
                break;
            case "Ostalo":
                kolicina = 1;
                cena = t.iznos || t.trosak || 0;
                break;
            default:
                kolicina = t.kolicina || t.brojRadnika || 0;
                cena = t.trosak || t.trosakPoRadniku || t.trosakPoJedinici || 0;
        }

        poDatumu[t.datum].push({
            id: t.id,
            tip: t.tip || "Tro≈°ak",
            kolicina,
            cena,
            prevoz,
            napomena: t.napomena || t.opis || ""
        });
    });

    // Grupisanje prihoda
    prihodiSnap.forEach(docSnap => {
        const p = docSnap.data();
        p.id = docSnap.id;
        if (!p.datum) return;
        if (!poDatumu[p.datum]) poDatumu[p.datum] = [];

        const prihodGlavni = p.kolicina || 0;
        const cena = p.prodajnaCena || p.ostalo?.iznos || 0;
        const napomena = p.ostalo?.opis || "";

        poDatumu[p.datum].push({
            id: p.id,
            tip: `Prihod (${p.kultura || "Nepoznato"})`,
            kolicina: prihodGlavni,
            cena,
            napomena
        });
    });

    if (Object.keys(poDatumu).length === 0) {
        pregledDiv.innerHTML = "<p style='text-align:center;'>Nema unetih podataka.</p>";
        return;
    }

    const datumi = Object.keys(poDatumu).sort((a, b) => b.localeCompare(a));

    pregledDiv.innerHTML = "<div class='date-list'><h3>Izaberite datum:</h3></div>";
    const listDiv = pregledDiv.querySelector(".date-list");

    datumi.forEach(datum => {
        const item = document.createElement("div");
        item.className = "date-item";

        const span = document.createElement("span");
        span.textContent = formatDatum(datum);
        span.onclick = () => prikaziDetalje(datum, poDatumu[datum]);

        const delBtn = document.createElement("button");
        delBtn.className = "trash";
        delBtn.innerHTML = "üóëÔ∏è";
        delBtn.title = "Obri≈°i sve unose za ovaj datum";
        delBtn.onclick = (e) => {
            e.stopPropagation();
            obrisiDatum(datum, poDatumu[datum]);
        };

        item.appendChild(span);
        item.appendChild(delBtn);
        listDiv.appendChild(item);
    });
});

// Prikaz detalja
function prikaziDetalje(datum, podaci) {
    const detailsDiv = document.createElement("div");
    detailsDiv.className = "details";
    let html = `<h3>${formatDatum(datum)}</h3>`;
    let zbir = 0;

    podaci.forEach(p => {
        const ukupno = (p.kolicina * p.cena) + (p.prevoz || 0);
        zbir += ukupno;
        html += `
            <div class="detail">
                <strong>${p.tip}</strong><br/>
                Koliƒçina/Cena: 
                <input type="text" value="${formatBroj(p.kolicina)}" id="kolicina-${p.id}" disabled /> x 
                <input type="text" value="${formatBroj(p.cena)}" id="cena-${p.id}" disabled /><br/>
                ${p.prevoz ? `Prevoz: <input type="text" value="${formatBroj(p.prevoz)}" id="prevoz-${p.id}" disabled /><br/>` : ""}
                Ukupno: ${formatBroj(ukupno)} RSD<br/>
                Napomena: <input type="text" value="${p.napomena}" id="napomena-${p.id}" disabled /><br/>
                <button class="editBtn" onclick="omoguciIzmenu('${p.id}')">‚úèÔ∏è Izmeni</button>
                <button class="saveBtn" onclick="sacuvajIzmene('${p.id}', '${p.tip}')" style="display:none;">üíæ Saƒçuvaj</button>
            </div>
        `;
    });

    html += `<div class="ukupno-datum">Ukupan zbir za ${formatDatum(datum)}: ${formatBroj(zbir)} RSD</div>`;
    detailsDiv.innerHTML = html;

    pregledDiv.innerHTML = "";
    pregledDiv.appendChild(detailsDiv);

    const nazadBtn = document.createElement("button");
    nazadBtn.textContent = "‚¨Ö Nazad na listu datuma";
    nazadBtn.onclick = () => window.location.reload();
    pregledDiv.appendChild(nazadBtn);
}

// Omoguƒáavanje izmene polja
window.omoguciIzmenu = function(id) {
    ["kolicina", "cena", "prevoz", "napomena"].forEach(field => {
        const el = document.getElementById(`${field}-${id}`);
        if (el) el.disabled = false;
    });
    const saveBtn = document.querySelector(`#cena-${id}`).closest(".detail").querySelector(".saveBtn");
    const editBtn = document.querySelector(`#cena-${id}`).closest(".detail").querySelector(".editBtn");
    saveBtn.style.display = "inline-block";
    editBtn.style.display = "none";
};

// ƒåuvanje izmena
window.sacuvajIzmene = async function(id, tip) {
    const docRef = doc(db, tip.startsWith("Prihod") ? "prihodi" : "troskovi", id);

    let kolicina = parseFloat(document.getElementById(`kolicina-${id}`).value.replace(/\./g,'').replace(',','.')) || 0;
    let cena = parseFloat(document.getElementById(`cena-${id}`).value.replace(/\./g,'').replace(',','.')) || 0;
    const prevozEl = document.getElementById(`prevoz-${id}`);
    const prevoz = prevozEl ? parseFloat(prevozEl.value.replace(/\./g,'').replace(',','.')) || 0 : 0;
    const napomena = document.getElementById(`napomena-${id}`).value;

    try {
        if (tip.startsWith("Prihod")) {
            await updateDoc(docRef, { kolicina, prodajnaCena: cena, "ostalo.iznos": cena, "ostalo.opis": napomena });
        } else {
            await updateDoc(docRef, { kolicina, trosak: cena, trosakPoRadniku: cena, trosakPoJedinici: cena, trosakPrevoza: prevoz, napomena });
        }
        alert("Izmene saƒçuvane!");
        window.location.reload();
    } catch (err) {
        console.error(err);
        alert("Gre≈°ka pri ƒçuvanju izmena: " + err.message);
    }
};

// Brisanje po datumu
async function obrisiDatum(datum, zapisi) {
    if (!confirm(`Da li ste sigurni da ≈æelite obrisati sve unose za datum ${formatDatum(datum)}?`)) return;

    try {
        for (const p of zapisi) {
            const ref = doc(db, p.tip.startsWith("Prihod") ? "prihodi" : "troskovi", p.id);
            await deleteDoc(ref);
        }
        alert("Svi unosi za izabrani datum su obrisani.");
        window.location.reload();
    } catch (err) {
        console.error(err);
        alert("Gre≈°ka pri brisanju: " + err.message);
    }
}
</script>

</body>
</html>








