<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sezonski radovi - Agritalia</title>
    <link rel="icon" href="icon-192.png" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
    <meta name="theme-color" content="#2e7d32" />
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            max-width: 480px;
            margin: 0 auto;
            background: #f7f7f7;
            color: #2e7d32;
            padding: 10px;
        }
        .logo {
            max-width: 150px;
            display: block;
            margin: 20px auto;
        }
        form {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 10px 0 6px;
            font-weight: 500;
        }
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            background-color: #2e7d32;
            color: white;
            font-weight: 700;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #27682c;
        }
        #status {
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 400;
        }
        #btnNazad {
            background-color: #ccc;
            color: #2e7d32;
            margin-top: 10px;
        }
        #btnNazad:hover {
            background-color: #b3b3b3;
        }
    </style>
</head>
<body>

    <img src="logo.png" alt="Agritalia Logo" class="logo" />
    <div id="status">Provera prijave...</div>

    <form id="sezonskiForm" style="display:none;">
        <h3>Unos sezonskih radova</h3>

        <label for="datum">Datum rada:</label>
        <input type="date" id="datum" required />

        <label for="kulturaSelect">Izaberite kulturu:</label>
        <select id="kulturaSelect" required>
            <option value="">-- Izaberite --</option>
            <option value="Malina">Malina</option>
            <option value="Borovnica">Borovnica</option>
            <option value="Jagoda">Jagoda</option>
            <option value="Drugo">Drugo</option>
        </select>
        <input type="text" id="kulturaDrugo" placeholder="Unesite drugu kulturu" style="display:none; margin-top: 5px;" />

        <label>Izaberite vrstu rada (moguće je više izbora):</label>
        <div class="checkbox-group" id="vrstaRadaGroup">
            <label><input type="checkbox" value="Košenje" /> Košenje</label>
            <label><input type="checkbox" value="Pleveljenje" /> Pleveljenje</label>
            <label><input type="checkbox" value="Okopavanje" /> Okopavanje</label>
            <label><input type="checkbox" value="Prskanje" /> Prskanje</label>
            <label><input type="checkbox" value="Đubrenje" /> Đubrenje</label>
            <label><input type="checkbox" value="Drugo" id="drugoCheckbox" /> Drugo</label>
        </div>
        <input type="text" id="vrstaRadaDrugo" placeholder="Unesite drugu vrstu rada" style="display:none; margin-top: 5px;" />

        <label for="sati">Broj radnih sati:</label>
        <input type="text" id="sati" placeholder="Unesite broj sati" pattern="[0-9]*[.,]?[0-9]*" inputmode="decimal" required />

        <label for="radnici">Broj radnika:</label>
        <input type="text" id="radnici" placeholder="Unesite broj radnika" pattern="[0-9]*" inputmode="numeric" required />

        <label for="trosak">Trošak po satu (RSD):</label>
        <input type="text" id="trosak" placeholder="Unesite trošak po satu" pattern="[0-9]*[.,]?[0-9]*" inputmode="decimal" required />

        <button type="submit">Sačuvaj</button>
    </form>

    <button id="btnNazad">Nazad</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGeFazvjgtDUbB-VSJlEcXDe4bW-r0sJs",
            authDomain: "agritalia-app.firebaseapp.com",
            projectId: "agritalia-app",
            storageBucket: "agritalia-app.appspot.com",
            messagingSenderId: "935329247921",
            appId: "1:935329247921:web:d9de1aa832e2432170a890"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const statusDiv = document.getElementById("status");
        const sezonskiForm = document.getElementById("sezonskiForm");
        const btnNazad = document.getElementById("btnNazad");

        const kulturaSelect = document.getElementById("kulturaSelect");
        const kulturaDrugo = document.getElementById("kulturaDrugo");
        const drugoCheckbox = document.getElementById("drugoCheckbox");
        const vrstaRadaDrugo = document.getElementById("vrstaRadaDrugo");

        kulturaSelect.addEventListener("change", () => {
            if (kulturaSelect.value === "Drugo") {
                kulturaDrugo.style.display = "block";
                kulturaDrugo.required = true;
            } else {
                kulturaDrugo.style.display = "none";
                kulturaDrugo.required = false;
            }
        });

        drugoCheckbox.addEventListener("change", () => {
            if (drugoCheckbox.checked) {
                vrstaRadaDrugo.style.display = "block";
                vrstaRadaDrugo.required = true;
            } else {
                vrstaRadaDrugo.style.display = "none";
                vrstaRadaDrugo.required = false;
            }
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                statusDiv.textContent = `Prijavljeni ste kao: ${user.displayName || user.email}`;
                sezonskiForm.style.display = "block";
            } else {
                statusDiv.textContent = "Niste prijavljeni. Molimo prijavite se.";
                sezonskiForm.style.display = "none";
            }
        });

        sezonskiForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("Morate biti prijavljeni da biste uneli podatke.");
                return;
            }

            const datum = document.getElementById("datum").value;
            let kultura = kulturaSelect.value;
            if (kultura === "Drugo") kultura = kulturaDrugo.value.trim();

            const checkboxes = document.querySelectorAll("#vrstaRadaGroup input[type='checkbox']:checked");
            const vrstaRada = [];
            checkboxes.forEach(cb => {
                if (cb.value === "Drugo" && vrstaRadaDrugo.value.trim() !== "") {
                    vrstaRada.push(vrstaRadaDrugo.value.trim());
                } else if (cb.value !== "Drugo") {
                    vrstaRada.push(cb.value);
                }
            });

            const sati = parseFloat(document.getElementById("sati").value.replace(",", "."));
            const radnici = parseInt(document.getElementById("radnici").value);
            const trosak = parseFloat(document.getElementById("trosak").value.replace(",", "."));

            if (!datum || !kultura || vrstaRada.length === 0 || isNaN(sati) || isNaN(radnici) || isNaN(trosak)) {
                alert("Popunite sva polja ispravno.");
                return;
            }

            try {
                await addDoc(collection(db, "sezonskiRadovi"), { // kolekcija promenjena na 'sezonskiRadovi'
                    userId: user.uid,
                    imePrezime: user.displayName || "",
                    datum,
                    kultura,
                    vrstaRada,
                    sati,
                    radnici,
                    trosak,
                    timestamp: new Date()
                });
                alert("Podaci uspešno sačuvani!");
                sezonskiForm.reset();
                kulturaDrugo.style.display = "none";
                vrstaRadaDrugo.style.display = "none";
            } catch (error) {
                alert("Greška pri čuvanju podataka: " + error.message);
            }
        });

        btnNazad.addEventListener("click", () => {
            window.history.back();
        });
    </script>

</body>
</html>

