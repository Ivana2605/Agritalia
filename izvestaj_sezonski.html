<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Izveštaj sezonskih radova - Agritalia</title>
<link rel="icon" href="icon-192.png" />
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
<meta name="theme-color" content="#2e7d32" />
<style>
body {
    font-family: 'Rubik', sans-serif;
    max-width: 480px;
    margin: 0 auto;
    background: #f7f7f7;
    color: #2e7d32;
    padding: 10px;
}
.logo { max-width: 150px; display: block; margin: 20px auto; }
h2, h3 { text-align: center; margin-bottom: 10px; }
.entry {
    background: white;
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
.entry-row {
    display: flex;
    justify-content: space-between;
    margin: 4px 0;
}
.entry-row .label { width: 140px; }
.entry-row .value {
    font-family: monospace;
    text-align: right;
    min-width: 120px;
}
.entry button.deleteBtn {
    background: #d32f2f;
    color: white;
    padding: 4px 12px;       /* manje dugme */
    border: none;
    border-radius: 6px;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
    display: block;
    margin: 10px auto 0 auto; /* centrirano ispod izveštaja */
    width: fit-content;       /* širina po sadržaju */
}
.entry button.deleteBtn:hover { background: #b71c1c; }

button {
    background: #2e7d32;
    color: white;
    padding: 10px;
    border: none;
    border-radius: 8px;
    width: 100%;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    margin-top: 10px;
}
button:hover { background: #27682c; }

form#periodForm {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    margin-top: 30px;
}
form#periodForm label { display: block; margin: 10px 0 6px; font-weight: 500; }
form#periodForm input[type="date"] {
    width: 100%; padding: 8px; font-size: 16px; border-radius: 8px;
    border: 1px solid #ccc; box-sizing: border-box;
}
#btnNazad {
    background-color: #e0e0e0; border: 2px solid #2e7d32; color: #2e7d32;
    font-weight: bold; padding: 10px; border-radius: 8px; cursor: pointer;
    width: 100%; font-size: 16px; margin-top: 10px;
}
#btnNazad:hover { background-color: #c8e6c9; color: #1b5e20; }
</style>
</head>
<body>

<img src="logo.png" class="logo" alt="Agritalia Logo" />
<h2>Izveštaj sezonskih radova</h2>

<div id="reportDate" style="text-align:center; font-weight:600; margin-bottom:10px;"></div>
<div id="reportContent"></div>

<form id="periodForm">
    <h3>Prikaži izveštaj za period</h3>
    <label for="datumOd">Datum od:</label>
    <input type="date" id="datumOd" required />
    <label for="datumDo">Datum do:</label>
    <input type="date" id="datumDo" required />
    <button type="submit">Prikaži izveštaj za period</button>
</form>

<button id="btnNazad">⬅ Nazad</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, deleteDoc, doc, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBGeFazvjgtDUbB-VSJlEcXDe4bW-r0sJs",
    authDomain: "agritalia-app.firebaseapp.com",
    projectId: "agritalia-app",
    storageBucket: "agritalia-app.appspot.com",
    messagingSenderId: "935329247921",
    appId: "1:935329247921:web:d9de1aa832e2432170a890"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const reportContent = document.getElementById("reportContent");
const reportDateDiv = document.getElementById("reportDate");
const periodForm = document.getElementById("periodForm");

function formatDateSR(dateStr){
    if(!dateStr) return "";
    const [y,m,d]=dateStr.split("-");
    return `${d}.${m}.${y}`;
}

function formatNum(num){
    return Number(num).toLocaleString('sr-RS', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function renderEntry(data){
    const sati = Number(data.sati)||0;
    const radnici = Number(data.radnici)||0;
    const trosakPoSatu = Number(data.trosak)||0;
    const trosakUkupno = sati*trosakPoSatu;

    const entryDiv = document.createElement("div");
    entryDiv.classList.add("entry");
    entryDiv.innerHTML = `
        <div class="entry-row"><span class="label">Datum:</span><span class="value">${formatDateSR(data.datum)}</span></div>
        <div class="entry-row"><span class="label">Vrsta rada:</span><span class="value">${Array.isArray(data.vrstaRada)?data.vrstaRada.join(", "):data.vrstaRada}</span></div>
        <div class="entry-row"><span class="label">Kultura:</span><span class="value">${data.kultura||'-'}</span></div>
        <div class="entry-row"><span class="label">Sati rada:</span><span class="value">${formatNum(sati)}</span></div>
        <div class="entry-row"><span class="label">Broj radnika:</span><span class="value">${formatNum(radnici)}</span></div>
        <div class="entry-row"><span class="label">Trošak:</span><span class="value">${formatNum(trosakUkupno)}<span class="currency"> RSD</span></span></div>
        <button class="deleteBtn">Obriši</button>
    `;
    reportContent.appendChild(entryDiv);

    entryDiv.querySelector(".deleteBtn").addEventListener("click", async ()=>{
        if(confirm("Da li želite da obrišete ovaj izveštaj?")){
            if(data.id){
                await deleteDoc(doc(db,"sezonskiRadovi",data.id));
            }
            entryDiv.remove();
        }
    });
}

async function loadReportByPeriod(user, od, doDatum){
    reportDateDiv.textContent = `Izveštaj za period: ${formatDateSR(od)} - ${formatDateSR(doDatum)}`;
    const radoviRef = collection(db,"sezonskiRadovi");
    const q = query(radoviRef,
        where("userId","==",user.uid),
        where("datum",">=",od),
        where("datum","<=",doDatum),
        orderBy("datum"),
        orderBy("__name__")
    );
    const snapshot = await getDocs(q);
    reportContent.innerHTML = "";
    if(snapshot.empty){
        reportContent.innerHTML=`<div class="entry">Nema podataka za izabrani period.</div>`;
        return;
    }

    snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        data.id = docSnap.id; // dodaj id da može da se briše
        renderEntry(data);
    });
}

onAuthStateChanged(auth,user=>{
    if(!user){ window.location.href="index.html"; return; }
});

document.getElementById("btnNazad").addEventListener("click",()=>{ window.location.href="dashboard.html"; });

periodForm.addEventListener("submit",e=>{
    e.preventDefault();
    const user = auth.currentUser;
    if(!user){ window.location.href="index.html"; return; }
    const od=document.getElementById("datumOd").value;
    const doDatum=document.getElementById("datumDo").value;
    if(!od||!doDatum){ alert("Unesite oba datuma."); return; }
    if(od>doDatum){ alert("Datum od mora biti manji ili jednak datumu do."); return; }
    loadReportByPeriod(user,od,doDatum);
});
</script>

</body>
</html>











