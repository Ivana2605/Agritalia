<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Bilans</title>

<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
    font-family: 'Rubik', sans-serif;
    font-weight: 400;
    max-width: 480px;
    margin: 0 auto;
    padding: 12px;
    background-color: #f7f7f7;
    color: #2e7d32;
    text-align: center;
    overflow-x: hidden;
}
h2 { margin: 20px 0; font-weight: 700; font-size: 1.6rem; }
form {
    margin-top: 20px;
    background: white;
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 12px;
}
form label { font-weight: 500; margin-bottom: 4px; font-size: 1rem; }
form input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
}
button {
    width: 100%;
    padding: 14px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    color: white;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
    transition: background-color 0.2s, transform 0.1s;
}
button:hover { opacity: 0.9; }
button:active { transform: scale(0.98); }
.pdfBtn { background: #1565c0; margin-top: 15px; }
.backBtn { background: #d32f2f; margin-top: 20px; }
.results {
    background: white;
    border-radius: 12px;
    padding: 16px;
    text-align: left;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-top: 20px;
    font-family: 'Rubik', sans-serif;
    font-weight: 400;
    word-break: break-word;
}
.positive { color: #2e7d32; font-weight: 700; }
.negative { color: #d32f2f; font-weight: 700; }
h3 { margin-top: 15px; font-weight: 500; font-size: 1.1rem; }
ul { padding-left: 20px; }
li { margin-bottom: 6px; font-size: 0.95rem; }

@media (max-width: 480px) {
    body { padding: 10px; }
    form { padding: 15px; }
    input, button { font-size: 16px; padding: 12px; }
    h2 { font-size: 1.5rem; }
}
</style>
</head>
<body>

<h2>Bilans</h2>

<form id="filterForm">
    <label for="datumOd">Datum od:</label>
    <input type="date" id="datumOd" required>

    <label for="datumDo">Datum do:</label>
    <input type="date" id="datumDo" required>

    <label for="brojParcele">Broj parcele:</label>
    <input type="text" id="brojParcele" placeholder="npr. 12a, 5/3..." required>

    <button type="submit" style="background-color:#2e7d32;">Prika≈æi bilans</button>
</form>

<div id="izvestajSadrzaj" style="display:none;">
    <div id="rezultati" class="results"></div>
    <button id="pdfBtn" class="pdfBtn">üìÑ Preuzmi izve≈°taj (PDF)</button>
</div>

<button class="backBtn" type="button" onclick="window.location.href='dashboard.html'">‚¨Ö Nazad</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBGeFazvjgtDUbB-VSJlEcXDe4bW-r0sJs",
    authDomain: "agritalia-app.firebaseapp.com",
    projectId: "agritalia-app",
    storageBucket: "agritalia-app.appspot.com",
    messagingSenderId: "935329247921",
    appId: "1:935329247921:web:d9de1aa832e2432170a890"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

function formatBroj(n) {
    return new Intl.NumberFormat('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
}

onAuthStateChanged(auth, async (user) => {
    if (!user) {
        alert("Morate biti prijavljeni!");
        window.location.href = "index.html";
        return;
    }

    document.getElementById("filterForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const datumOd = document.getElementById("datumOd").value;
        const datumDo = document.getElementById("datumDo").value;
        const brojParcele = document.getElementById("brojParcele").value.trim();

        if (!datumOd || !datumDo || !brojParcele) {
            alert("Molimo unesite datume i broj parcele!");
            return;
        }

        const troskoviSnap = await getDocs(query(collection(db, "troskovi"), where("userId","==",user.uid)));
        const prihodiSnap = await getDocs(query(collection(db, "prihodi"), where("userId","==",user.uid)));

        let poTipuTroskova = {};
        let poTipuPrihoda = {};
        let ukupniTroskovi = 0;
        let ukupniPrihodi = 0;

        troskoviSnap.forEach(docSnap => {
            const t = docSnap.data();
            if (!t.datum || t.brojParcele !== brojParcele) return;
            if (t.datum >= datumOd && t.datum <= datumDo) {
                let ukupno = 0;
                switch(t.tip) {
                    case "Sezonci":
                        ukupno = (t.trosakPoRadniku||0)*(t.brojRadnika||0) + (t.trosakPrevoza||0);
                        break;
                    case "ƒêubriva":
                    case "Pesticidi":
                        ukupno = (t.trosak||0)*(t.kolicina||1);
                        break;
                    case "Gorivo":
                        ukupno = (t.kolicinaLitara||0)*(t.cenaPoLitru||0) || t.trosak||0;
                        break;
                    case "Ostalo":
                        ukupno = t.trosak || t.iznos || 0;
                        break;
                    default:
                        ukupno = t.trosak || t.iznos || 0;
                }
                poTipuTroskova[t.tip] = (poTipuTroskova[t.tip]||0)+ukupno;
                ukupniTroskovi += ukupno;
            }
        });

        prihodiSnap.forEach(docSnap => {
            const p = docSnap.data();
            if (!p.datum || p.brojParcele !== brojParcele) return;
            if (p.datum >= datumOd && p.datum <= datumDo) {
                let prihod = (p.kolicina||0)*(p.prodajnaCena||0);
                if (p.ostalo?.iznos) prihod += p.ostalo.iznos;
                const tip = p.tip || "Ostalo";
                poTipuPrihoda[tip] = (poTipuPrihoda[tip]||0) + prihod;
                ukupniPrihodi += prihod;
            }
        });

        const bilans = ukupniPrihodi - ukupniTroskovi;

        let troskoviHTML = "<h3>Tro≈°kovi po tipu</h3><ul>";
        for(const [tip, iznos] of Object.entries(poTipuTroskova)) {
            troskoviHTML += `<li>${tip}: ${formatBroj(iznos)} RSD</li>`;
        }
        troskoviHTML += `<li><strong>Ukupno tro≈°kovi: ${formatBroj(ukupniTroskovi)} RSD</strong></li></ul>`;

        let prihodiHTML = "<h3>Prihodi po tipu</h3><ul>";
        for(const [tip, iznos] of Object.entries(poTipuPrihoda)) {
            prihodiHTML += `<li>${tip}: ${formatBroj(iznos)} RSD</li>`;
        }
        prihodiHTML += `<li><strong>Ukupno prihodi: ${formatBroj(ukupniPrihodi)} RSD</strong></li></ul>`;

        document.getElementById('rezultati').innerHTML = `
            <h3>Bilans za parcelu ${brojParcele}</h3>
            ${troskoviHTML}
            ${prihodiHTML}
            <h3>Rezultat: <span class="${bilans>=0?'positive':'negative'}">${bilans>=0?'Dobitak':'Gubitak'}: ${formatBroj(Math.abs(bilans))} RSD</span></h3>
        `;

        document.getElementById('izvestajSadrzaj').style.display="block";
    });
});

// PDF
document.getElementById('pdfBtn').addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p","mm","a4");
    const sadrzaj = document.getElementById("izvestajSadrzaj");
    const canvasImg = await html2canvas(sadrzaj, {scale:2});
    const imgData = canvasImg.toDataURL("image/png");
    const pdfWidth = 190;
    const pdfHeight = (canvasImg.height*pdfWidth)/canvasImg.width;
    pdf.text("Bilans", 15,15);
    pdf.addImage(imgData,"PNG",10,25,pdfWidth,pdfHeight);
    const datumOd = document.getElementById('datumOd').value;
    const datumDo = document.getElementById('datumDo').value;
    const brojParcele = document.getElementById('brojParcele').value.trim();
    pdf.save(`Bilans_parcela_${brojParcele}_${datumOd}_do_${datumDo}.pdf`);
});
</script>
</body>
</html>













